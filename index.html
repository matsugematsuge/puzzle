<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å®çŸ³ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
  * {
    touch-action: none !important;
    user-select: none;
    -webkit-user-select: none;
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0; height: 100dvh;
    background: linear-gradient(135deg, #0f001a, #1a0033);
    color: #eee; font-family: system-ui, sans-serif;
    overflow: hidden; display: flex; flex-direction: column; align-items: center;
  }
  #container {
    width: 100%; max-width: 480px; height: 100%;
    padding: 10px; display: flex; flex-direction: column;
  }

  /* ä¸Šéƒ¨ãƒãƒ«ãƒè¡¨ç¤º */
  #top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  #norma { display: flex; gap: 8px; }
  .norma-item {
    background: rgba(40,20,80,0.7); border: 2px solid #6644aa; border-radius: 12px;
    padding: 4px 10px; text-align: center; min-width: 70px;
    font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 4px;
  }
  .norma-green { color: #66ff99; }
  .norma-pink  { color: #ff99dd; }
  .norma-yellow{ color: #ffff88; }

  /* ç›¤é¢ã®è¨­å®šï¼šå›ºå®špxã‚’å»ƒæ­¢ã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã« */
  #board-container {
    background: #0a0a1a; border: 4px solid #443366; border-radius: 8px;
    width: 100%; aspect-ratio: 1 / 1; position: relative;
  }
  #board {
    display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr);
    gap: 2px; padding: 2px; width: 100%; height: 100%;
  }
  .cell {
    background: rgba(255,255,255,0.05); border-radius: 4px;
    width: 100%; height: 100%; position: relative;
  }
  
  /* å®çŸ³ã®è‰² */
  .filled { box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
  .color-1 { background: #e67e22; } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
  .color-2 { background: #66ff99; } /* ç·‘ */
  .color-3 { background: #ff99dd; } /* ãƒ”ãƒ³ã‚¯ */
  .color-4 { background: #ffff88; } /* é»„è‰² */

  /* æ‰‹æŒã¡ãƒ–ãƒ­ãƒƒã‚¯ã®è¡¨ç¤º */
  #hand {
    flex: 1; display: flex; justify-content: space-around; align-items: center;
    padding: 10px 0; gap: 10px;
  }
  .piece { cursor: grab; transition: transform 0.2s; }
  .piece-grid { display: grid; gap: 2px; }
  .piece-cell { width: 25px; height: 25px; border-radius: 3px; }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆé…ç½®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ */
  .preview {
    position: absolute; inset: 0; opacity: 0.4; border-radius: 4px; z-index: 5;
  }

  /* ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ */
  .overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.8);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: 0.5s; z-index: 100;
  }
  .overlay.show { opacity: 1; pointer-events: all; }
  .restart-btn {
    margin-top: 15px; padding: 10px 25px; background: #6644aa; color: white;
    border: none; border-radius: 20px; font-weight: bold;
  }
</style>
</head>
<body>

<div id="container">
  <div id="top-bar">
    <div id="norma">
      <div class="norma-item norma-green">ğŸŸ© <span id="c2">0/5</span></div>
      <div class="norma-item norma-pink">ğŸŸ¥ <span id="c3">0/5</span></div>
      <div class="norma-item norma-yellow">ğŸŸ¨ <span id="c4">0/5</span></div>
    </div>
    <div style="font-size: 0.8rem; opacity: 0.7;">æ“ä½œ: <span id="moveCount">0</span></div>
    <button id="resetBtn" style="background:none; border:none; color:white; font-size:1.2rem;">â†»</button>
  </div>

  <div id="board-container">
    <div id="board"></div>
    <div class="overlay" id="gameover">GAME OVER</div>
    <div class="overlay" id="clearScreen">
      ğŸ‰ CLEAR! ğŸ‰
      <button class="restart-btn" id="restartBtn">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
    </div>
  </div>

  <div id="hand"></div>
</div>

<script>
const SIZE = 8;
let board = Array(SIZE).fill().map(()=>Array(SIZE).fill(0));
let counts = {2:0, 3:0, 4:0};
let normaTargets = {2:5, 3:5, 4:10};
let clearedColors = new Set();
let hand = [];
let moveCount = 0;
let gameOver = false;

const SHAPES = [
  [[0,0],[1,0],[2,0],[2,1]], // L
  [[0,0],[0,1],[0,2],[1,2]], // é€†L
  [[0,0],[0,1]],             // 2ãƒã‚¹
  [[0,0],[0,1],[0,2],[0,3]], // 4ãƒã‚¹æ£’
  [[0,0],[0,1],[1,0],[1,1]], // æ­£æ–¹å½¢
  [[0,0],[0,1],[0,2],[1,1]]  // T
];

function init() {
  board = Array(SIZE).fill().map(()=>Array(SIZE).fill(0));
  counts = {2:0, 3:0, 4:0};
  clearedColors.clear();
  moveCount = 0;
  gameOver = false;
  
  // ç›¤é¢åˆæœŸåŒ–
  const boardEl = document.getElementById('board');
  boardEl.innerHTML = '';
  for(let y=0; y<SIZE; y++) {
    for(let x=0; x<SIZE; x++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.x = x; cell.dataset.y = y;
      boardEl.appendChild(cell);
    }
  }

  // 10å€‹ã®åˆæœŸé…ç½®
  for(let i=0; i<10; i++) {
    let x, y;
    do { x = Math.floor(Math.random()*SIZE); y = Math.floor(Math.random()*SIZE); } while(board[y][x]);
    board[y][x] = Math.floor(Math.random()*4) + 1;
  }

  refillHand();
  render();
  updateUI();
  document.querySelectorAll('.overlay').forEach(el => el.classList.remove('show'));
}

function refillHand() {
  const handEl = document.getElementById('hand');
  handEl.innerHTML = '';
  hand = [];
  for(let i=0; i<3; i++) {
    const shape = SHAPES[Math.floor(Math.random()*SHAPES.length)];
    // ã‚¯ãƒªã‚¢ã—ãŸè‰²ã¯å‡ºç¾ã—ãªã„
    let colors = [1,2,3,4].filter(c => !clearedColors.has(c));
    const pieceColors = shape.map(() => colors[Math.floor(Math.random()*colors.length)]);
    
    const pieceObj = { shape, colors: pieceColors };
    const pieceEl = createPieceEl(pieceObj, i);
    hand.push(pieceObj);
    handEl.appendChild(pieceEl);
  }
}

function createPieceEl(piece, index) {
  const grid = document.createElement('div');
  grid.className = 'piece';
  const w = Math.max(...piece.shape.map(s => s[1])) + 1;
  const h = Math.max(...piece.shape.map(s => s[0])) + 1;
  
  const inner = document.createElement('div');
  inner.className = 'piece-grid';
  inner.style.gridTemplateColumns = `repeat(${w}, 1fr)`;
  
  for(let y=0; y<h; y++) {
    for(let x=0; x<w; x++) {
      const cell = document.createElement('div');
      cell.className = 'piece-cell';
      const colorIdx = piece.shape.findIndex(s => s[0] === y && s[1] === x);
      if(colorIdx !== -1) cell.classList.add(`color-${piece.colors[colorIdx]}`, 'filled');
      inner.appendChild(cell);
    }
  }
  grid.appendChild(inner);

  // ã‚¹ãƒãƒ›ç”¨ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œ
  grid.addEventListener('touchstart', (e) => handleStart(e, index, grid));
  grid.addEventListener('touchmove', handleMove);
  grid.addEventListener('touchend', handleEnd);
  return grid;
}

let activeIdx = -1;
let dragEl = null;
let lastTarget = null;

function handleStart(e, idx, el) {
  if(gameOver) return;
  activeIdx = idx;
  dragEl = el;
  el.style.transform = 'scale(1.2) translateY(-50px)'; // æŒ‡ã§è¦‹ãˆã‚‹ã‚ˆã†ã«ä¸Šã«ãšã‚‰ã™
}

function handleMove(e) {
  if(activeIdx === -1) return;
  const touch = e.touches[0];
  const boardRect = document.getElementById('board').getBoundingClientRect();
  const x = Math.floor((touch.clientX - boardRect.left) / (boardRect.width / SIZE));
  const y = Math.floor((touch.clientY - boardRect.top - 50) / (boardRect.height / SIZE)); // ãšã‚Œã‚’è€ƒæ…®

  document.querySelectorAll('.preview').forEach(p => p.remove());
  if(x >= 0 && x < SIZE && y >= 0 && y < SIZE) {
    showPreview(y, x, hand[activeIdx]);
    lastTarget = {x, y};
  } else {
    lastTarget = null;
  }
}

function handleEnd() {
  if(activeIdx === -1) return;
  if(lastTarget) {
    if(placePiece(lastTarget.y, lastTarget.x, hand[activeIdx])) {
      hand[activeIdx] = null;
      dragEl.style.visibility = 'hidden';
      moveCount++;
      if(hand.every(h => h === null)) refillHand();
      checkClear();
    }
  }
  if(dragEl) dragEl.style.transform = '';
  document.querySelectorAll('.preview').forEach(p => p.remove());
  activeIdx = -1;
  render();
  updateUI();
}

function showPreview(by, bx, piece) {
  if(!canPlace(by, bx, piece)) return;
  piece.shape.forEach((s, i) => {
    const cell = document.querySelector(`.cell[data-x="${bx+s[1]}"][data-y="${by+s[0]}"]`);
    if(cell) {
      const p = document.createElement('div');
      p.className = `preview color-${piece.colors[i]}`;
      cell.appendChild(p);
    }
  });
}

function canPlace(by, bx, piece) {
  return piece.shape.every(s => {
    const ny = by + s[0], nx = bx + s[1];
    return ny < SIZE && nx < SIZE && board[ny][nx] === 0;
  });
}

function placePiece(by, bx, piece) {
  if(!canPlace(by, bx, piece)) return false;
  piece.shape.forEach((s, i) => {
    const color = piece.colors[i];
    board[by+s[0]][bx+s[1]] = color;
    if(counts[color] !== undefined) counts[color]++;
  });
  return true;
}

function checkClear() {
  let linesY = [], linesX = [];
  for(let i=0; i<SIZE; i++) {
    if(board[i].every(v => v > 0)) linesY.push(i);
    if(board.every(row => row[i] > 0)) linesX.push(i);
  }
  
  linesY.forEach(y => board[y].fill(0));
  linesX.forEach(x => board.forEach(row => row[x] = 0));

  // ãƒãƒ«ãƒãƒã‚§ãƒƒã‚¯ã¨è‰²å¤‰æ›
  [2,3,4].forEach(c => {
    if(counts[c] >= normaTargets[c] && !clearedColors.has(c)) {
      clearedColors.add(c);
      // ç›¤é¢ã®ã‚¯ãƒªã‚¢ã•ã‚ŒãŸè‰²ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆcolor-1ï¼‰ã« [cite: 2026-01-05]
      for(let y=0; y<SIZE; y++) for(let x=0; x<SIZE; x++) if(board[y][x] === c) board[y][x] = 1;
      // æ‰‹æŒã¡ã®ã‚¯ãƒªã‚¢ã•ã‚ŒãŸè‰²ã‚‚å¤‰æ› [cite: 2026-01-05]
      hand.forEach(p => {
        if(p) p.colors = p.colors.map(col => col === c ? 1 : col);
      });
    }
  });

  if(clearedColors.size === 3) document.getElementById('clearScreen').classList.add('show');
}

function render() {
  document.querySelectorAll('.cell').forEach(el => {
    const x = el.dataset.x, y = el.dataset.y;
    const v = board[y][x];
    el.className = 'cell' + (v ? ` color-${v} filled` : '');
  });
}

function updateUI() {
  document.getElementById('c2').innerText = `${counts[2]}/${normaTargets[2]}`;
  document.getElementById('c3').innerText = `${counts[3]}/${normaTargets[3]}`;
  document.getElementById('c4').innerText = `${counts[4]}/${normaTargets[4]}`;
  document.getElementById('moveCount').innerText = moveCount;
}

init();
document.getElementById('resetBtn').onclick = init;
document.getElementById('restartBtn').onclick = init;
</script>
</body>
</html>